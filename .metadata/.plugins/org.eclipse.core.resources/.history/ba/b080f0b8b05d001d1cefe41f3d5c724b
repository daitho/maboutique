-- définition maboutique.categorie

-- Tableau de chute

-- DROP TABLE maboutique.categorie;

CRÉER TABLE maboutique.categorie (
	id int4 NON NULL GÉNÉRÉ PAR DÉFAUT COMME IDENTITÉ,
	nom varchar(50) PAS NULL,
	CONSTRAINT categorie_pkey CLÉ PRIMAIRE (id)
);

-- Autorisations

MODIFIER LA TABLE maboutique.categorie PROPRIETAIRE DE postgres;
GRANT ALL ON TABLE maboutique.categorie TO postgres;
ACCORDER TOUT SUR TABLE maboutique.categorie À maboutique;


-- définition maboutique.utilisateur

-- Tableau de chute

-- DROP TABLE maboutique.utilisateur;

CRÉER TABLE maboutique.utilisateur (
	id int4 NON NULL GÉNÉRÉ PAR DÉFAUT COMME IDENTITÉ,
	nom varchar(50) PAS NULL,
	prenom varchar(50) PAS NULL,
	email varchar(50) PAS NULL,
	motdepasse varchar(50) NON NULL,
	"admin" booléen PAS NULL,
	CONTRAINTE utilisateur_pkey CLE PRIMAIRE (id)
);

-- Autorisations

ALTER TABLE maboutique.utilisateur PROPRIÉTAIRE À postgres;
GRANT ALL ON TABLE maboutique.utilisateur TO postgres;
GRANT ALL ON TABLE maboutique.utilisateur TO maboutique;


-- définition maboutique.produit

-- Tableau de chute

-- DROP TABLE maboutique.produit;

CREER TABLE maboutique.produit (
	id int4 NON NULL GÉNÉRÉ PAR DÉFAUT COMME IDENTITÉ,
	nom varchar(50) PAS NULL,
	prix float8 NOT NULL,
	idcategorie int4 NOT NULL,
	idvendeur int4 NOT NULL,
	idacheteur int4 NULL,
	statut bpchar(1) NOT NULL DEFAULT 'D'::bpchar,
	quantité int4 NOT NULL DEFAULT 0,
	CONTRAINTE produit_pkey CLE PRIMAIRE (id),
	CONTRAINTE produit_statut_check CHECK ((statut = ANY (ARRAY['D'::bpchar, 'C'::bpchar, 'V'::bpchar]))),
	CONTRAINTE produit_idacheteur_fkey FOREIGN KEY (idacheteur) REFERENCES maboutique.utilisateur(id),
	CONTRAINTE produit_idcategorie_fkey FOREIGN KEY (idcategorie) REFERENCES maboutique.categorie(id),
	CONTRAINTE produit_idvendeur_fkey CLE ETRANGERE (idvendeur) REFERENCES maboutique.utilisateur(id)
);

-- Autorisations

ALTER TABLE maboutique.produit PROPRIETAIRE A postgres;
ACCORDER TOUT SUR TABLE maboutique.produit A postgres;
ACCORDER TOUT SUR TABLE maboutique.produit A maboutique;


-- définition de maboutique.historiqueachat

-- Tableau de chute

-- DROP TABLE maboutique.historiqueachat;

CRÉER TABLE maboutique.historiqueachat (
	id int4 NON NULL GÉNÉRÉ PAR DÉFAUT COMME IDENTITÉ,
	quantité int4 NOT NULL,
	idproduit int4 NOT NULL,
	idacheteur int4 NOT NULL,
	CONTRAINTE historiqueachat_pkey CLE PRIMAIRE (id),
	CONTRAINTE historiqueachat_idacheteur_fkey FOREIGN KEY (idacheteur) REFERENCES maboutique.utilisateur(id),
	CONTRAINTE historiqueachat_idproduit_fkey FOREIGN KEY (idproduit) REFERENCES maboutique.produit(id)
);

-- Autorisations

MODIFIER LA TABLE maboutique.historiqueachat PROPRIETAIRE A postgres;
ACCORDER TOUT SUR TABLE maboutique.historiqueachat À postgres;
ACCORDER TOUT SUR TABLE maboutique.historiqueachat À maboutique;

INSÉRER DANS les VALEURS maboutique.utilisateur (nom,prenom,email,motdepasse,"admin")
	 ('Durand','Pierre','pdurand@3il.fr','pdurand',faux),
	 ('Salim','Ali','asalim@3il.fr','asalim',faux),
	 ('Admin','Admin','admin@3il.fr','admin',vrai);

INSERT INTO maboutique.categorie (nom) VALEURS
	 ("informatique"),
	 ('consommable'),
	 ('bureautique');

INSERT INTO maboutique.produit (nom,prix,idcategorie,idvendeur,idacheteur,statut,quantité) VALUES
	 ('Carte graphique RTX',120.0,1,3,1,'C',0),
	 ('Clavier optique',65.26,2,3,1,'D',4),
	 ('Nintendo Commutateur',500.0,1,2,3,'C',0),
	 ('Souris sans fil',15.0,1,1,3,'D',77),
	 ('Tablette graphique',152.0,1,1,3,'D',15),
	 ("Cartouches d'encre",35.0,1,2,3,'D',5),
	 ('Ecran 21"',123.0,1,1,3,'D',5),
	 ('Ecran 19"',99.0,2,1,3,'C',5),
	 ('Stylo bille noir',3.5,2,1,3,'D',2);

INSERT INTO maboutique.historiqueachat (quantite,idproduit,idacheteur) VALEURS
	 (6,10,3),
	 (1,10,3),
	 (1,9,3),
	 (2,11,1),
	 (2,3,1),
	 (2,11,1),
	 (2,3,1),
	 (2,9,3),
	 (2,9,3),
	 (2,4,3);
	 